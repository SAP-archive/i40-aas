#!/bin/bash

echo "Executing script to prepare a clean registry database."

#read -p "Enter path to SQL dumps (generated by emob-backup-user, without trailing slash): " path_to_sql_dumps
#path_to_sql_dumps=$1

echo "host: $CORE_REGISTRIES_ENDPOINTS_DATABASE_HOST"
echo "port: $CORE_REGISTRIES_ENDPOINTS_DATABASE_PORT"
echo "db: $CORE_REGISTRIES_ENDPOINTS_DATABASE_NAME"
echo "user: $CORE_REGISTRIES_ENDPOINTS_DATABASE_USER"
#echo "pw: $CORE_REGISTRIES_ENDPOINTS_DATABASE_PASSWORD"

#echo "Prepare .pgpass"

#sed -i "s/PW-PLACEHOLDER/${CORE_REGISTRIES_ENDPOINTS_DATABASE_PASSWORD}/g" .pgpass
#PGPASSFILE="~/registry/.pgpass"

echo "Dropping existing database tables..."

PGPASSWORD=$CORE_REGISTRIES_ENDPOINTS_DATABASE_PASSWORD dropdb -h $CORE_REGISTRIES_ENDPOINTS_DATABASE_HOST -p $CORE_REGISTRIES_ENDPOINTS_DATABASE_PORT -U $CORE_REGISTRIES_ENDPOINTS_DATABASE_USER -w -e $CORE_REGISTRIES_ENDPOINTS_DATABASE_NAME

echo "Create database new..."

#PGPASSWORD=$CORE_REGISTRIES_ENDPOINTS_DATABASE_PASSWORD psql -h $CORE_REGISTRIES_ENDPOINTS_DATABASE_HOST -p $CORE_REGISTRIES_ENDPOINTS_DATABASE_PORT -U $CORE_REGISTRIES_ENDPOINTS_DATABASE_USER -d $CORE_REGISTRIES_ENDPOINTS_DATABASE_NAME create_database.sql
PGPASSWORD=$CORE_REGISTRIES_ENDPOINTS_DATABASE_PASSWORD createdb -h $CORE_REGISTRIES_ENDPOINTS_DATABASE_HOST -p $CORE_REGISTRIES_ENDPOINTS_DATABASE_PORT -U $CORE_REGISTRIES_ENDPOINTS_DATABASE_USER -w -e --tablespace=pg_default --encoding='UTF8' --lc-collate='en_US.utf8' --lc-ctype='en_US.utf8' $CORE_REGISTRIES_ENDPOINTS_DATABASE_NAME

echo "Create tables"

PGPASSWORD=$CORE_REGISTRIES_ENDPOINTS_DATABASE_PASSWORD psql -h $CORE_REGISTRIES_ENDPOINTS_DATABASE_HOST -p $CORE_REGISTRIES_ENDPOINTS_DATABASE_PORT -U $CORE_REGISTRIES_ENDPOINTS_DATABASE_USER -d $CORE_REGISTRIES_ENDPOINTS_DATABASE_NAME -w -e -f sql/create_assets.sql
PGPASSWORD=$CORE_REGISTRIES_ENDPOINTS_DATABASE_PASSWORD psql -h $CORE_REGISTRIES_ENDPOINTS_DATABASE_HOST -p $CORE_REGISTRIES_ENDPOINTS_DATABASE_PORT -U $CORE_REGISTRIES_ENDPOINTS_DATABASE_USER -d $CORE_REGISTRIES_ENDPOINTS_DATABASE_NAME -w -e -f sql/create_asset_administration_shells.sql
PGPASSWORD=$CORE_REGISTRIES_ENDPOINTS_DATABASE_PASSWORD psql -h $CORE_REGISTRIES_ENDPOINTS_DATABASE_HOST -p $CORE_REGISTRIES_ENDPOINTS_DATABASE_PORT -U $CORE_REGISTRIES_ENDPOINTS_DATABASE_USER -d $CORE_REGISTRIES_ENDPOINTS_DATABASE_NAME -w -e -f sql/create_endpoints.sql
PGPASSWORD=$CORE_REGISTRIES_ENDPOINTS_DATABASE_PASSWORD psql -h $CORE_REGISTRIES_ENDPOINTS_DATABASE_HOST -p $CORE_REGISTRIES_ENDPOINTS_DATABASE_PORT -U $CORE_REGISTRIES_ENDPOINTS_DATABASE_USER -d $CORE_REGISTRIES_ENDPOINTS_DATABASE_NAME -w -e -f sql/create_semantic_protocols.sql
PGPASSWORD=$CORE_REGISTRIES_ENDPOINTS_DATABASE_PASSWORD psql -h $CORE_REGISTRIES_ENDPOINTS_DATABASE_HOST -p $CORE_REGISTRIES_ENDPOINTS_DATABASE_PORT -U $CORE_REGISTRIES_ENDPOINTS_DATABASE_USER -d $CORE_REGISTRIES_ENDPOINTS_DATABASE_NAME -w -e -f sql/create_roles.sql
PGPASSWORD=$CORE_REGISTRIES_ENDPOINTS_DATABASE_PASSWORD psql -h $CORE_REGISTRIES_ENDPOINTS_DATABASE_HOST -p $CORE_REGISTRIES_ENDPOINTS_DATABASE_PORT -U $CORE_REGISTRIES_ENDPOINTS_DATABASE_USER -d $CORE_REGISTRIES_ENDPOINTS_DATABASE_NAME -w -e -f sql/create_aas_role.sql
